<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content=""><meta name="google-site-verification" content="UKlpQSB6IlVlxjxgprQbTNRUiLE1BnpIV5zeQ_MYkks"><title> android插件化简要概述以及谈谈QQ的插件化原理大概 · 情迁博客</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="android插件化简要概述以及谈谈QQ的插件化原理大概 - 情随事迁"><meta name="keywords"><meta name="author" content="情随事迁"><meta name="referrer" content="no-referrer"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="https://lozn.top/atom.xml" title="情迁博客"><meta name="generator" content="Hexo 5.4.1"></head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="/images/logo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="归档" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="https://godhand.lozn.top" target="_blank" data-hover="神之手" class="nav-list-link">神之手</a></li><li class="nav-list-item"><a href="https://robot.lozn.top" target="_blank" data-hover="机器人" class="nav-list-link">机器人</a></li><li class="nav-list-item"><a href="/categories/情迁软件/" target="_self" data-hover="情迁" class="nav-list-link">情迁</a></li><li class="nav-list-item"><a href="https://www.jianshu.com/u/9b0768e66d01" target="_blank" data-hover="简书" class="nav-list-link">简书</a></li><li class="nav-list-item"><a href="/update/" target="_self" data-hover="下载" class="nav-list-link">下载</a></li><li class="nav-list-item"><a href="/about/" target="_self" data-hover="关于" class="nav-list-link">关于</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page --><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">android插件化简要概述以及谈谈QQ的插件化原理大概</h1><div class="post-info">2018-04-01<p class="visit"><i data-hk-page="current">Loading</i><span>次访问</span></p></div><div class="post-content"><p>简书链接:<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/2c19328899e0">android插件化简要概述以及谈谈QQ的插件化原理大概</a><br>文章字数：1831,阅读全文大约需要7分钟<br>构建一个插件化了解几个关键点，就可以实现一个可以架构一个支持比较简单粗糙的插件化apk了，能拿到插件apk  classloader的 就可以实现加载任意插件apk的类<br>知道<code>Resources</code>如何根据apk生成自然就可以操作任意布局,其他的就是使用类似包装模式一样的架构完成生命周期的代理.</p>
<h3 id="动态加载插件apk-dex"><a href="#动态加载插件apk-dex" class="headerlink" title="动态加载插件apk dex"></a>动态加载插件apk dex</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">        File dexOutFileDir = context.getDir(&quot;dex&quot;, Context.MODE_PRIVATE);</span><br><span class="line">String pluginApkPath=new File(context.getDir(&quot;plugin&quot;),&quot;my.apk&quot;).getAbsolutePath();</span><br><span class="line">        dexClassLoader = new DexClassLoader(pluginApkPath, dexOutFileDir .getAbsolutePath() , null, context.getClassLoader());</span><br><span class="line">//拿到了classloader就可以加载任意类了</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="动态加载资源"><a href="#动态加载资源" class="headerlink" title="动态加载资源"></a>动态加载资源</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">         AssetManager assetManager = AssetManager.class.newInstance();</span><br><span class="line">         Method addAssetPath = AssetManager.class.getMethod(&quot;addAssetPath&quot;, String.class);</span><br><span class="line">         addAssetPath.invoke(assetManager, path);</span><br><span class="line">         resources = new Resources(assetManager, context.getResources().getDisplayMetrics(), context.getResources().getConfiguration());</span><br><span class="line">     &#125; catch (Exception e) &#123;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">         Toast.makeText(context, &quot;加载失败&quot;, Toast.LENGTH_SHORT).show();</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<h3 id="演示架构代理插件activity"><a href="#演示架构代理插件activity" class="headerlink" title="演示架构代理插件activity"></a>演示架构代理插件activity</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">//主activiy声明，但是不能是单例,这个不需要多说,其次在onCreate里面加载插件apk。</span><br><span class="line">public class MyProxyActivity extends Activity &#123;</span><br><span class="line"></span><br><span class="line">    private String className;</span><br><span class="line">    IPluginProxyActivity ipluginProxyActivity;</span><br><span class="line">    // com.dongnao.alvin.taopiaopiao.MainActivity</span><br><span class="line">    @Override</span><br><span class="line">    public void onCreate(@Nullable Bundle savedInstanceState  ) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState );</span><br><span class="line">        className = getIntent().getStringExtra(&quot;className&quot;);</span><br><span class="line">//        class</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            Class activityClass = getClassLoader().loadClass(className);</span><br><span class="line">            Constructor constructor = activityClass.getConstructor(new Class[]&#123;&#125;);</span><br><span class="line">            Object instance= constructor.newInstance(new Object[]&#123;&#125;);</span><br><span class="line">//          可以</span><br><span class="line">            ipluginProxyActivity = (IPluginProxyActivity) instance;</span><br><span class="line"></span><br><span class="line">            ipluginProxyActivity.attach(this);</span><br><span class="line">            Bundle bundle = new Bundle();</span><br><span class="line">            ipluginProxyActivity.onCreate(bundle);</span><br><span class="line"></span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">            Toast.makeText(this, &quot;找不到class:&quot;+className, Toast.LENGTH_SHORT).show();</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void startActivity(Intent intent) &#123;</span><br><span class="line">        String className1=intent.getStringExtra(&quot;className&quot;);</span><br><span class="line">        Intent intent1 = new Intent(this, MyProxyActivity.class);</span><br><span class="line">        intent1.putExtra(&quot;className&quot;, className1);</span><br><span class="line">        super.startActivity(intent1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public ComponentName startService(Intent service) &#123;</span><br><span class="line">        String serviceName = service.getStringExtra(&quot;serviceName&quot;);</span><br><span class="line">        Intent intent1 = new Intent(this, ProxyService.class);</span><br><span class="line">        intent1.putExtra(&quot;serviceName&quot;, serviceName);</span><br><span class="line">        return super.startService(intent1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public ClassLoader getClassLoader() &#123;</span><br><span class="line">        return PluginManager.getInstance().getDexClassLoader();//可以定义pluginId,方便扩展</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Resources getResources() &#123;</span><br><span class="line">        return PluginManager.getInstance().getResources();//可以定义pluginId,方便扩展</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void onStart() &#123;</span><br><span class="line">        super.onStart();</span><br><span class="line">        if(ipluginProxyActivity ==null)&#123;</span><br><span class="line">            Toast.makeText(this, &quot;获取payInterActivity fail&quot;, Toast.LENGTH_SHORT).show();</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        ipluginProxyActivity.onStart();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void onDestroy() &#123;</span><br><span class="line">        super.onDestroy();</span><br><span class="line">        ipluginProxyActivity.onDestroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void onPause() &#123;</span><br><span class="line">        super.onPause();</span><br><span class="line">        ipluginProxyActivity.onPause();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="根据资源id查资源名或反查"><a href="#根据资源id查资源名或反查" class="headerlink" title="根据资源id查资源名或反查"></a>根据资源id查资源名或反查</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">public int getIdentifier(int resId) &#123;</span><br><span class="line">    if (isDefaultSkin) &#123;</span><br><span class="line">        return resId;</span><br><span class="line">    &#125;</span><br><span class="line">    //在皮肤包中不一定就是 当前程序的 id</span><br><span class="line">    //获取对应id 在当前的名称 colorPrimary</span><br><span class="line">    //R.drawable.ic_launcher</span><br><span class="line">    String resName = mAppResources.getResourceEntryName(resId);//ic_launcher</span><br><span class="line">    String resType = mAppResources.getResourceTypeName(resId);//drawable</span><br><span class="line">    int skinId = mSkinResources.getIdentifier(resName, resType, mSkinPkgName);</span><br><span class="line">    return skinId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public int getColor(int resId) &#123;</span><br><span class="line">    if (isDefaultSkin) &#123;</span><br><span class="line">        return mAppResources.getColor(resId);</span><br><span class="line">    &#125;</span><br><span class="line">    int skinId = getIdentifier(resId);</span><br><span class="line">    if (skinId == 0) &#123;</span><br><span class="line">        return mAppResources.getColor(resId);</span><br><span class="line">    &#125;</span><br><span class="line">    return mSkinResources.getColor(skinId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public ColorStateList getColorStateList(int resId) &#123;</span><br><span class="line">    if (isDefaultSkin) &#123;</span><br><span class="line">        return mAppResources.getColorStateList(resId);</span><br><span class="line">    &#125;</span><br><span class="line">    int skinId = getIdentifier(resId);</span><br><span class="line">    if (skinId == 0) &#123;</span><br><span class="line">        return mAppResources.getColorStateList(resId);</span><br><span class="line">    &#125;</span><br><span class="line">    return mSkinResources.getColorStateList(skinId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public Drawable getDrawable(int resId) &#123;</span><br><span class="line">    //如果有皮肤  isDefaultSkin false 没有就是true</span><br><span class="line">    if (isDefaultSkin) &#123;</span><br><span class="line">        return mAppResources.getDrawable(resId);</span><br><span class="line">    &#125;</span><br><span class="line">    int skinId = getIdentifier(resId);</span><br><span class="line">    if (skinId == 0) &#123;</span><br><span class="line">        return mAppResources.getDrawable(resId);</span><br><span class="line">    &#125;</span><br><span class="line">    return mSkinResources.getDrawable(skinId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="hook拦截activity启动"><a href="#hook拦截activity启动" class="headerlink" title="hook拦截activity启动"></a>hook拦截activity启动</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//可以追踪startAcitivty最终调用哪里</span><br><span class="line">Class&lt;?&gt; activityManagerNativeClass = Class.forName(&quot;android.app.ActivityManagerNative&quot;);</span><br><span class="line"> Field gDefaultField = activityManagerNativeClass.getDeclaredField(&quot;gDefault&quot;);</span><br><span class="line"> gDefaultField.setAccessible(true);</span><br><span class="line"> Object gDefault = gDefaultField.get(null);</span><br><span class="line"> // gDefault是一个 android.util.Singleton对象; 我们取出这个单例里面的字段</span><br><span class="line"> Class&lt;?&gt; singleton = Class.forName(&quot;android.util.Singleton&quot;);</span><br><span class="line"> Field mInstanceField = singleton.getDeclaredField(&quot;mInstance&quot;);</span><br><span class="line"> mInstanceField.setAccessible(true);</span><br><span class="line"> // ActivityManagerNative 的gDefault对象里面原始的 IActivityManager对象</span><br><span class="line"> Object rawIActivityManager = mInstanceField.get(gDefault);</span><br><span class="line"> // 创建一个这个对象的代理对象, 然后替换这个字段, 让我们的代理对象帮忙干活</span><br><span class="line"> Class&lt;?&gt; iActivityManagerInterface = Class.forName(&quot;android.app.IActivityManager&quot;)</span><br><span class="line"> Object proxy = Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader</span><br><span class="line"> new Class&lt;?&gt;[] &#123; iActivityManagerInterface &#125;, new IActivityManagerHandler(</span><br><span class="line"> mInstanceField.set(gDefault, proxy);</span><br></pre></td></tr></table></figure>

<h3 id="反射实现静态recervicer变成动态加载"><a href="#反射实现静态recervicer变成动态加载" class="headerlink" title="反射实现静态recervicer变成动态加载"></a>反射实现静态recervicer变成动态加载</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">//反射的代码 根据 如下2个文件源码分析总结</span><br><span class="line">  </span><br><span class="line">//\frameworks\base\services\core\java\com\android\server\pm\PackageManagerService.java</span><br><span class="line">//\frameworks\base\core\java\android\content\pm\PackageParser.java</span><br><span class="line">        try &#123;</span><br><span class="line"></span><br><span class="line">            Class   packageParserClass = Class.forName(&quot;android.content.pm.PackageParser&quot;);</span><br><span class="line">            Method parsePackageMethod = packageParserClass.getDeclaredMethod(&quot;parsePackage&quot;, File.class, int.class);</span><br><span class="line">            Object packageParser = packageParserClass.newInstance();</span><br><span class="line">           Object packageObj=  parsePackageMethod.invoke(packageParser, new File(path), PackageManager.GET_ACTIVITIES);</span><br><span class="line">            Field receiverField=packageObj.getClass().getDeclaredField(&quot;receivers&quot;);</span><br><span class="line">            List receivers = (List) receiverField.get(packageObj);</span><br><span class="line"></span><br><span class="line">            Class&lt;?&gt; componentClass = Class.forName(&quot;android.content.pm.PackageParser$Component&quot;);</span><br><span class="line">            Field intentsField = componentClass.getDeclaredField(&quot;intents&quot;);</span><br><span class="line"></span><br><span class="line">            // 调用generateActivityInfo 方法, 把PackageParser.Activity 转换成</span><br><span class="line">            Class&lt;?&gt; packageParser$ActivityClass = Class.forName(&quot;android.content.pm.PackageParser$Activity&quot;);</span><br><span class="line">//            generateActivityInfo方法</span><br><span class="line">            Class&lt;?&gt; packageUserStateClass = Class.forName(&quot;android.content.pm.PackageUserState&quot;);</span><br><span class="line">           Object defaltUserState= packageUserStateClass.newInstance();</span><br><span class="line">            Method generateReceiverInfo = packageParserClass.getDeclaredMethod(&quot;generateActivityInfo&quot;,</span><br><span class="line">                    packageParser$ActivityClass, int.class, packageUserStateClass, int.class);</span><br><span class="line">            Class&lt;?&gt; userHandler = Class.forName(&quot;android.os.UserHandle&quot;);</span><br><span class="line">            Method getCallingUserIdMethod = userHandler.getDeclaredMethod(&quot;getCallingUserId&quot;);</span><br><span class="line">            int userId = (int) getCallingUserIdMethod.invoke(null);</span><br><span class="line">            for (Object activity : receivers) &#123;</span><br><span class="line">               ActivityInfo info= (ActivityInfo) generateReceiverInfo.invoke(packageParser,  activity,0, defaltUserState, userId);</span><br><span class="line">               BroadcastReceiver broadcastReceiver= (BroadcastReceiver) dexClassLoader.loadClass(info.name).newInstance();</span><br><span class="line">                List&lt;? extends IntentFilter&gt; intents= (List&lt;? extends IntentFilter&gt;) intentsField.get(activity);</span><br><span class="line">                for (IntentFilter intentFilter : intents) &#123;</span><br><span class="line">                    context.registerReceiver(broadcastReceiver, intentFilter);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            //generateActivityInfo</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h3 id="定义接口实现类加载后直接强转接口"><a href="#定义接口实现类加载后直接强转接口" class="headerlink" title="定义接口实现类加载后直接强转接口"></a>定义接口实现类加载后直接强转接口</h3><h3 id="支持拦截的代理接口"><a href="#支持拦截的代理接口" class="headerlink" title="支持拦截的代理接口"></a>支持拦截的代理接口</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line">//Proxy 只支持接口，因此没有定义接口的没戏</span><br><span class="line">public interface IActivityManager extends IInterface &#123;</span><br><span class="line"></span><br><span class="line">    public int startActivity(IApplicationThread caller,</span><br><span class="line">            Intent intent, String resolvedType, Uri[] grantedUriPermissions,</span><br><span class="line">            int grantedMode, IBinder resultTo, String resultWho, int requestCode,</span><br><span class="line">            boolean onlyIfNeeded, boolean debug) throws RemoteException;</span><br><span class="line">    public WaitResult startActivityAndWait(IApplicationThread caller,</span><br><span class="line">            Intent intent, String resolvedType, Uri[] grantedUriPermissions,</span><br><span class="line">            int grantedMode, IBinder resultTo, String resultWho, int requestCode,</span><br><span class="line">            boolean onlyIfNeeded, boolean debug) throws RemoteException;</span><br><span class="line">    public int startActivityWithConfig(IApplicationThread caller,</span><br><span class="line">            Intent intent, String resolvedType, Uri[] grantedUriPermissions,</span><br><span class="line">            int grantedMode, IBinder resultTo, String resultWho, int requestCode,</span><br><span class="line">            boolean onlyIfNeeded, boolean debug, Configuration newConfig) throws RemoteException;</span><br><span class="line">    public int startActivityIntentSender(IApplicationThread caller,</span><br><span class="line">            IntentSender intent, Intent fillInIntent, String resolvedType,</span><br><span class="line">            IBinder resultTo, String resultWho, int requestCode,</span><br><span class="line">            int flagsMask, int flagsValues) throws RemoteException;</span><br><span class="line">    public boolean startNextMatchingActivity(IBinder callingActivity,</span><br><span class="line">            Intent intent) throws RemoteException;</span><br><span class="line">    public boolean finishActivity(IBinder token, int code, Intent data)</span><br><span class="line">            throws RemoteException;</span><br><span class="line">    public void finishSubActivity(IBinder token, String resultWho, int requestCode) throws RemoteException;</span><br><span class="line">    public boolean willActivityBeVisible(IBinder token) throws RemoteException;</span><br><span class="line">    public Intent registerReceiver(IApplicationThread caller,</span><br><span class="line">            IIntentReceiver receiver, IntentFilter filter,</span><br><span class="line">            String requiredPermission) throws RemoteException;</span><br><span class="line">    public void unregisterReceiver(IIntentReceiver receiver) throws RemoteException;</span><br><span class="line">    public static final int BROADCAST_SUCCESS = 0;</span><br><span class="line">    public static final int BROADCAST_STICKY_CANT_HAVE_PERMISSION = -1;</span><br><span class="line">    public int broadcastIntent(IApplicationThread caller, Intent intent,</span><br><span class="line">            String resolvedType, IIntentReceiver resultTo, int resultCode,</span><br><span class="line">            String resultData, Bundle map, String requiredPermission,</span><br><span class="line">            boolean serialized, boolean sticky) throws RemoteException;</span><br><span class="line">    public void unbroadcastIntent(IApplicationThread caller, Intent intent) throws RemoteException;</span><br><span class="line">    /* oneway */</span><br><span class="line">    public void finishReceiver(IBinder who, int resultCode, String resultData, Bundle map, boolean abortBroadcast) throws RemoteException;</span><br><span class="line">    public void attachApplication(IApplicationThread app) throws RemoteException;</span><br><span class="line">    /* oneway */</span><br><span class="line">    public void activityIdle(IBinder token, Configuration config) throws RemoteException;</span><br><span class="line">    public void activityPaused(IBinder token, Bundle state) throws RemoteException;</span><br><span class="line">    /* oneway */</span><br><span class="line">    public void activityStopped(IBinder token,</span><br><span class="line">                                Bitmap thumbnail, CharSequence description) throws RemoteException;</span><br><span class="line">    /* oneway */</span><br><span class="line">    public void activityDestroyed(IBinder token) throws RemoteException;</span><br><span class="line">    public String getCallingPackage(IBinder token) throws RemoteException;</span><br><span class="line">    public ComponentName getCallingActivity(IBinder token) throws RemoteException;</span><br><span class="line">    public List getTasks(int maxNum, int flags,</span><br><span class="line">                         IThumbnailReceiver receiver) throws RemoteException;</span><br><span class="line">    public List&lt;ActivityManager.RecentTaskInfo&gt; getRecentTasks(int maxNum,</span><br><span class="line">            int flags) throws RemoteException;</span><br><span class="line">    public List getServices(int maxNum, int flags) throws RemoteException;</span><br><span class="line">    public List&lt;ActivityManager.ProcessErrorStateInfo&gt; getProcessesInErrorState()</span><br><span class="line">            throws RemoteException;</span><br><span class="line">    public void moveTaskToFront(int task) throws RemoteException;</span><br><span class="line">    public void moveTaskToBack(int task) throws RemoteException;</span><br><span class="line">    public boolean moveActivityTaskToBack(IBinder token, boolean nonRoot) throws RemoteException;</span><br><span class="line">    public void moveTaskBackwards(int task) throws RemoteException;</span><br><span class="line">    public int getTaskForActivity(IBinder token, boolean onlyRoot) throws RemoteException;</span><br><span class="line">    public void finishOtherInstances(IBinder token, ComponentName className) throws RemoteException;</span><br><span class="line">    /* oneway */</span><br><span class="line">    public void reportThumbnail(IBinder token,</span><br><span class="line">            Bitmap thumbnail, CharSequence description) throws RemoteException;</span><br><span class="line">    public ContentProviderHolder getContentProvider(IApplicationThread caller,</span><br><span class="line">            String name) throws RemoteException;</span><br><span class="line">    public void removeContentProvider(IApplicationThread caller,</span><br><span class="line">            String name) throws RemoteException;</span><br><span class="line">    public void publishContentProviders(IApplicationThread caller,</span><br><span class="line">            List&lt;ContentProviderHolder&gt; providers) throws RemoteException;</span><br><span class="line">    public PendingIntent getRunningServiceControlPanel(ComponentName service)</span><br><span class="line">            throws RemoteException;</span><br><span class="line">    public ComponentName startService(IApplicationThread caller, Intent service,</span><br><span class="line">            String resolvedType) throws RemoteException;</span><br><span class="line">    public int stopService(IApplicationThread caller, Intent service,</span><br><span class="line">            String resolvedType) throws RemoteException;</span><br><span class="line">    public boolean stopServiceToken(ComponentName className, IBinder token,</span><br><span class="line">            int startId) throws RemoteException;</span><br><span class="line">    public void setServiceForeground(ComponentName className, IBinder token,</span><br><span class="line">            int id, Notification notification, boolean keepNotification) throws RemoteException;</span><br><span class="line">    public int bindService(IApplicationThread caller, IBinder token,</span><br><span class="line">            Intent service, String resolvedType,</span><br><span class="line">            IServiceConnection connection, int flags) throws RemoteException;</span><br><span class="line">    public boolean unbindService(IServiceConnection connection) throws RemoteException;</span><br><span class="line">    public void publishService(IBinder token,</span><br><span class="line">            Intent intent, IBinder service) throws RemoteException;</span><br><span class="line">    public void unbindFinished(IBinder token, Intent service,</span><br><span class="line">            boolean doRebind) throws RemoteException;</span><br><span class="line">    /* oneway */</span><br><span class="line">    public void serviceDoneExecuting(IBinder token, int type, int startId,</span><br><span class="line">            int res) throws RemoteException;</span><br><span class="line">    public IBinder peekService(Intent service, String resolvedType) throws RemoteException;</span><br><span class="line">    </span><br><span class="line">    public boolean bindBackupAgent(ApplicationInfo appInfo, int backupRestoreMode)</span><br><span class="line">            throws RemoteException;</span><br><span class="line">    public void backupAgentCreated(String packageName, IBinder agent) throws RemoteException;</span><br><span class="line">    public void unbindBackupAgent(ApplicationInfo appInfo) throws RemoteException;</span><br><span class="line">    public void killApplicationProcess(String processName, int uid) throws RemoteException;</span><br><span class="line">    </span><br><span class="line">    public boolean startInstrumentation(ComponentName className, String profileFile,</span><br><span class="line">            int flags, Bundle arguments, IInstrumentationWatcher watcher)</span><br><span class="line">            throws RemoteException;</span><br><span class="line">    public void finishInstrumentation(IApplicationThread target,</span><br><span class="line">            int resultCode, Bundle results) throws RemoteException;</span><br><span class="line"></span><br><span class="line">    public Configuration getConfiguration() throws RemoteException;</span><br><span class="line">    public void updateConfiguration(Configuration values) throws RemoteException;</span><br><span class="line">    public void setRequestedOrientation(IBinder token,</span><br><span class="line">            int requestedOrientation) throws RemoteException;</span><br><span class="line">    public int getRequestedOrientation(IBinder token) throws RemoteException;</span><br><span class="line">    </span><br><span class="line">    public ComponentName getActivityClassForToken(IBinder token) throws RemoteException;</span><br><span class="line">    public String getPackageForToken(IBinder token) throws RemoteException;</span><br><span class="line"></span><br><span class="line">    public static final int INTENT_SENDER_BROADCAST = 1;</span><br><span class="line">    public static final int INTENT_SENDER_ACTIVITY = 2;</span><br><span class="line">    public static final int INTENT_SENDER_ACTIVITY_RESULT = 3;</span><br><span class="line">    public static final int INTENT_SENDER_SERVICE = 4;</span><br><span class="line">    public IIntentSender getIntentSender(int type,</span><br><span class="line">            String packageName, IBinder token, String resultWho,</span><br><span class="line">            int requestCode, Intent intent, String resolvedType, int flags) throws RemoteException;</span><br><span class="line">    public void cancelIntentSender(IIntentSender sender) throws RemoteException;</span><br><span class="line">    public boolean clearApplicationUserData(final String packageName,</span><br><span class="line">            final IPackageDataObserver observer) throws RemoteException;</span><br><span class="line">    public String getPackageForIntentSender(IIntentSender sender) throws RemoteException;</span><br><span class="line">    </span><br><span class="line">    public void setProcessLimit(int max) throws RemoteException;</span><br><span class="line">    public int getProcessLimit() throws RemoteException;</span><br><span class="line">    </span><br><span class="line">    public void setProcessForeground(IBinder token, int pid, boolean isForeground) throws RemoteException;</span><br><span class="line">    </span><br><span class="line">    public int checkPermission(String permission, int pid, int uid)</span><br><span class="line">            throws RemoteException;</span><br><span class="line"></span><br><span class="line">    public int checkUriPermission(Uri uri, int pid, int uid, int mode)</span><br><span class="line">            throws RemoteException;</span><br><span class="line">    public void grantUriPermission(IApplicationThread caller, String targetPkg,</span><br><span class="line">            Uri uri, int mode) throws RemoteException;</span><br><span class="line">    public void revokeUriPermission(IApplicationThread caller, Uri uri,</span><br><span class="line">            int mode) throws RemoteException;</span><br><span class="line">    </span><br><span class="line">    public void showWaitingForDebugger(IApplicationThread who, boolean waiting)</span><br><span class="line">            throws RemoteException;</span><br><span class="line">    </span><br><span class="line">    public void getMemoryInfo(ActivityManager.MemoryInfo outInfo) throws RemoteException;</span><br><span class="line">    </span><br><span class="line">    public void killBackgroundProcesses(final String packageName) throws RemoteException;</span><br><span class="line">    public void forceStopPackage(final String packageName) throws RemoteException;</span><br><span class="line">    </span><br><span class="line">    // Note: probably don&#x27;t want to allow applications access to these.</span><br><span class="line">    public void goingToSleep() throws RemoteException;</span><br><span class="line">    public void wakingUp() throws RemoteException;</span><br><span class="line">    </span><br><span class="line">    public void unhandledBack() throws RemoteException;</span><br><span class="line">    public ParcelFileDescriptor openContentUri(Uri uri) throws RemoteException;</span><br><span class="line">    public void setDebugApp(</span><br><span class="line">        String packageName, boolean waitForDebugger, boolean persistent)</span><br><span class="line">        throws RemoteException;</span><br><span class="line">    public void setAlwaysFinish(boolean enabled) throws RemoteException;</span><br><span class="line">    public void setActivityController(IActivityController watcher)</span><br><span class="line">        throws RemoteException;</span><br><span class="line"></span><br><span class="line">    public void enterSafeMode() throws RemoteException;</span><br><span class="line">    </span><br><span class="line">    public void noteWakeupAlarm(IIntentSender sender) throws RemoteException;</span><br><span class="line">    </span><br><span class="line">    public boolean killPids(int[] pids, String reason) throws RemoteException;</span><br><span class="line">//省略了很多............................</span><br></pre></td></tr></table></figure>



<h3 id="我利用这个技术做了什么？"><a href="#我利用这个技术做了什么？" class="headerlink" title="我利用这个技术做了什么？"></a>我利用这个技术做了什么？</h3><p>我的机器人插件功能就是这样实现的,各位想开发QQ机器人插件的朋友欢迎加入哦!<br>插件sdk支持禁言，踢人</p>
<p>插件demo地址<br><a target="_blank" rel="noopener" href="https://gitee.com/51bwn/RobotPluginSDK">https://gitee.com/51bwn/RobotPluginSDK</a><br>插件机器人没有ui界面哈</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">DexClassLoader dexClassLoader = new DexClassLoader(currentApk.getAbsolutePath(), getDefaultPluginDexPath(context).getAbsolutePath(), null, context.getClassLoader());</span><br><span class="line">                  try &#123;</span><br><span class="line">                      Class&lt;?&gt; aClass = dexClassLoader.loadClass(Cns.PLUGIN_MAIN_ENTRY_FILE);</span><br><span class="line">                      PluginInterface pluginInterface = (PluginInterface) aClass.newInstance();</span><br><span class="line">                      pluginInterface.onCreate(context);</span><br><span class="line">                      QueryPluginModel model = new QueryPluginModel();</span><br><span class="line">                      model.setPluginInterface(pluginInterface);</span><br><span class="line">                      model.setOfficial(pluginInterface.getPackageName().startsWith(BuildConfig.APPLICATION_ID));</span><br><span class="line">                      model.setPath(currentApk.getAbsolutePath());</span><br><span class="line">                      if (onCreateNotify != null) &#123;</span><br><span class="line">                          onCreateNotify.onEach(pluginInterface);</span><br><span class="line">                      &#125;</span><br><span class="line">                      list.add(model);</span><br><span class="line">                      if (BuildConfig.DEBUG) &#123;</span><br><span class="line"></span><br><span class="line">                          Log.w(TAG, &quot;加载插件&quot; + currentApk.getAbsolutePath() + &quot;成功&quot;);</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">                      e.printStackTrace();</span><br><span class="line">                      Log.e(TAG, &quot;加载&quot; + currentApk.getName() + &quot;文件插件失败,非机器人插件或插件apk被混淆，导致找不到&quot; + Cns.PLUGIN_MAIN_ENTRY_FILE + &quot;类&quot;);</span><br><span class="line">                  &#125; catch (IllegalAccessException e) &#123;</span><br><span class="line">                      e.printStackTrace();</span><br><span class="line">                      Log.e(TAG, &quot;加载插件失败,无法创建对象 IllegalAccessException 可能没有访问权限&quot;);</span><br><span class="line">                  &#125; catch (InstantiationException e) &#123;</span><br><span class="line">                      e.printStackTrace();</span><br><span class="line">                      Log.e(TAG, &quot;加载插件失败,无法创建对象InstantiationException &quot;);</span><br><span class="line">                  &#125; catch (Exception e) &#123;</span><br><span class="line">                      e.printStackTrace();</span><br><span class="line">                      Log.e(TAG, &quot;加载插件失败,未知异常 &quot; + e.getMessage());</span><br><span class="line">                  &#125; catch (Error e) &#123;</span><br><span class="line">                      e.printStackTrace();</span><br><span class="line">                      Log.e(TAG, &quot;加载插件失败,未知错误 &quot; + e.getMessage());</span><br><span class="line">                  &#125;</span><br></pre></td></tr></table></figure>


<p> 上面的方式是固定的class规定，实际上也可以读取资产目录，然后只读取资产目录文件里面规定的类型,</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">//PluginInterface 文件</span><br><span class="line">/**</span><br><span class="line"> * Created by qssq on 2018/1/21 qssq666@foxmail.com</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">public interface PluginInterface &#123;</span><br><span class="line">	/**</span><br><span class="line">	 * 插件作者</span><br><span class="line">	 * @return</span><br><span class="line">	 */</span><br><span class="line">	public String getAuthorName();</span><br><span class="line">	/**</span><br><span class="line">	 * 当机器人插件被创建加载后，会回调配置api控制类给插件，插件可以自己存储为成员变量，在适当的逻辑中进行操作，此api接口回调支持踢人禁言,发消息</span><br><span class="line">	 * @param instance</span><br><span class="line">	 */</span><br><span class="line">	public void onReceiveControlApi(PluginCtronolInterface instance);</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 插件的版本号</span><br><span class="line">	 * </span><br><span class="line">	 * @return</span><br><span class="line">	 */</span><br><span class="line">	public int getVersionCode();</span><br><span class="line">	public String getBuildTime();</span><br><span class="line">	/**</span><br><span class="line">	 * </span><br><span class="line">	 * @return 插件的版本名</span><br><span class="line">	 */</span><br><span class="line">	public String getVersionName();</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * </span><br><span class="line">	 * @return 插件的包名(不要和作者的包名一样!否则)为了用户的安全，恶意流氓插件我会强制处理，对于冒充官方包名的插件校验签名。所以不要用cn.</span><br><span class="line">	 *         qssq666开头的包名。</span><br><span class="line">	 */</span><br><span class="line">	public String getPackageName();</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 此机器人插件的描述信息</span><br><span class="line">	 * </span><br><span class="line">	 * @return 返回此插件的描述信息</span><br><span class="line">	 */</span><br><span class="line">	public String getDescript();</span><br><span class="line">	/**</span><br><span class="line">	 * 插件的名字，这里当然是中文名了，给用户看的名字嘛</span><br><span class="line">	 * @return</span><br><span class="line">	 */</span><br><span class="line">	public String getPluginName();</span><br><span class="line"></span><br><span class="line">	// boolean isOfficial();</span><br><span class="line">	/**</span><br><span class="line">	 * 本插件是否被禁用了,这和卸载不同，卸载的话文件都删除了，但是是否禁用是由用户自己实现的</span><br><span class="line">	 * </span><br><span class="line">	 * @return</span><br><span class="line">	 */</span><br><span class="line">	boolean isDisable();</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * ，在修改机器人插件配置右边的选项卡会调用setDisable</span><br><span class="line">	 * 不写无法禁用，影响体验，导致的后果就是被用户卸载咯!具体怎么实现禁用请参考demo源码</span><br><span class="line">	 * </span><br><span class="line">	 * @param disable</span><br><span class="line">	 */</span><br><span class="line">	void setDisable(boolean disable);</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 插件被加载进来后会把宿主的上下文传递过来，不过我感觉有风险啊，有了这东西什么都可以反射了。</span><br><span class="line">	 * </span><br><span class="line">	 * @param context</span><br><span class="line">	 */</span><br><span class="line">	void onCreate(Context context);</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 这里是处理逻辑的关键,首先自身命令和管理员命令逻辑会先走,之后走这里提供消息判断是否处理了此消息，如果处理了就返回true,</span><br><span class="line">	 * </span><br><span class="line">	 * @param item</span><br><span class="line">	 * @return 插件处理了本消息就返回true,那么其他插件，或者机器人将不会被处理，防止冲突。</span><br><span class="line">	 */</span><br><span class="line">	boolean onReceiveMsgIsNeedIntercept(MsgItem item);</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 这个方法暂时没用，</span><br><span class="line">	 */</span><br><span class="line">	void onDestory();</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 插件刚加载后会提供一个机器人配置查询接口，比如已经禁用了群聊功能了，你这个机器人插件不听话还进行处理，那么下场也是被卸载了.</span><br><span class="line">	 * </span><br><span class="line">	 * @param robotConfigInterface</span><br><span class="line">	 */</span><br><span class="line">	void onReceiveRobotConfig(RobotConfigInterface robotConfigInterface);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>分析手机QQ插件化原理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//com.tencent.mobileqq.pluginsdk.PluginProxyActivity</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">private void b() throws Exception &#123;</span><br><span class="line">    PackageInfo packageInfoWithException;</span><br><span class="line">    PackageInfo packageInfo = (PackageInfo) PluginStatic.d.get(this.g);</span><br><span class="line">    if (packageInfo == null) &#123;</span><br><span class="line">        if (DebugHelper.sDebug) &#123;</span><br><span class="line">            DebugHelper.log(&quot;PluginProxyActivity.initPlugin start getPackageInfo&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            packageInfoWithException = ApkFileParser.getPackageInfoWithException(this, this.g, 129);</span><br><span class="line">            if (DebugHelper.sDebug) &#123;</span><br><span class="line">                DebugHelper.log(&quot;PluginProxyActivity.initPlugin end getPackageInfo, &quot; + packageInfoWithException);</span><br><span class="line">            &#125;</span><br><span class="line">            if (packageInfoWithException == null) &#123;</span><br><span class="line">                throw new a(&quot;Get Package Info Failed!&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            PluginStatic.d.put(this.g, packageInfoWithException);</span><br><span class="line">        &#125; catch (Throwable th) &#123;</span><br><span class="line">            a aVar = new a(&quot;getPackageInfoWithException&quot;, th);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        packageInfoWithException = packageInfo;</span><br><span class="line">    &#125;</span><br><span class="line">    if (this.j == null || this.j.length() == 0) &#123;</span><br><span class="line">        if (packageInfoWithException.activities == null || packageInfoWithException.activities.length == 0) &#123;</span><br><span class="line">            throw new b();</span><br><span class="line">        &#125;</span><br><span class="line">        this.j = packageInfoWithException.activities[0].name;</span><br><span class="line">    &#125;</span><br><span class="line">    ClassLoader a = PluginStatic.a((Context) this, this.i, this.g);</span><br><span class="line">    getIntent().setExtrasClassLoader(a);</span><br><span class="line">    if (DebugHelper.sDebug) &#123;</span><br><span class="line">        DebugHelper.log(&quot;PluginProxyActivity.initPlugin start loadClass&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    this.d = a.loadClass(this.j);</span><br><span class="line">    if (DebugHelper.sDebug) &#123;</span><br><span class="line">        DebugHelper.log(&quot;PluginProxyActivity.initPlugin start loadClass&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    this.mPluginActivity = (IPluginActivity) this.d.newInstance();</span><br><span class="line">    this.mPluginActivity.IInit(this.i, this.g, this, a, packageInfoWithException, this.e, this.f);</span><br><span class="line">    Intent intent = new Intent(getIntent());</span><br><span class="line">    Bundle bundleExtra = intent.getBundleExtra(INNER_INTENT_EXTRAS);</span><br><span class="line">    if (bundleExtra != null) &#123;</span><br><span class="line">        intent.putExtras(bundleExtra);</span><br><span class="line">        intent.removeExtra(INNER_INTENT_EXTRAS);</span><br><span class="line">    &#125;</span><br><span class="line">    this.mPluginActivity.ISetIntent(intent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>分析<code>com.tencent.mobileqq.pluginsdk.PluginStatic</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br></pre></td><td class="code"><pre><span class="line">public abstract class PluginStatic &#123;</span><br><span class="line">    public static final String PARAM_CLASS_STATISTICS_UPLOADER = &quot;clsUploader&quot;;</span><br><span class="line">    public static final String PARAM_CLEAR_TOP = &quot;cleartop&quot;;</span><br><span class="line">    public static final String PARAM_EXTRA_INFO = &quot;pluginsdk_extraInfo&quot;;</span><br><span class="line">    public static final String PARAM_LAUNCH_ACTIVITY = &quot;pluginsdk_launchActivity&quot;;</span><br><span class="line">    public static final String PARAM_LAUNCH_SERVICE = &quot;pluginsdk_launchService&quot;;</span><br><span class="line">    public static final String PARAM_PATH = &quot;pluginsdk_pluginpath&quot;;</span><br><span class="line">    public static final String PARAM_PLUGIN_GESTURELOCK = &quot;param_plugin_gesturelock&quot;;</span><br><span class="line">    public static final String PARAM_PLUGIN_INTERNAL_ACTIVITIES_ONLY = &quot;PARAM_PLUGIN_INTERNAL_ACTIVITIES_ONLY&quot;;</span><br><span class="line">    public static final String PARAM_PLUGIN_LOCATION = &quot;pluginsdk_pluginLocation&quot;;</span><br><span class="line">    public static final String PARAM_PLUGIN_NAME = &quot;pluginsdk_pluginName&quot;;</span><br><span class="line">    public static final String PARAM_PLUGIN_RECEIVER_CLASS_NAME = &quot;pluginsdk_launchReceiver&quot;;</span><br><span class="line">    public static final String PARAM_UIN = &quot;pluginsdk_selfuin&quot;;</span><br><span class="line">    public static final String PARAM_USE_QQ_RESOURCES = &quot;userQqResources&quot;;</span><br><span class="line">    public static final String PARAM_USE_SKIN_ENGINE = &quot;useSkinEngine&quot;;</span><br><span class="line">    public static final int USER_QQ_RESOURCES_BOTH = 2;</span><br><span class="line">    public static final int USER_QQ_RESOURCES_NO = -1;</span><br><span class="line">    public static final int USER_QQ_RESOURCES_YES = 1;</span><br><span class="line">    static final String a = &quot;com.tencent.mobileqq&quot;;</span><br><span class="line">    static final String b = &quot;pluginsdk_IsPluginActivity&quot;;</span><br><span class="line">    static final ConcurrentHashMap c = new ConcurrentHashMap();</span><br><span class="line">    static final ConcurrentHashMap d = new ConcurrentHashMap();</span><br><span class="line">    private static final HashMap e = new HashMap();</span><br><span class="line">    private static ArrayList f = new ArrayList();</span><br><span class="line"></span><br><span class="line">    public interface IPluginLife &#123;</span><br><span class="line">        void onLoad();</span><br><span class="line"></span><br><span class="line">        void onUnload();</span><br><span class="line">    &#125;</span><br><span class="line">//上下文 读取    插件的id,插件apk的路径</span><br><span class="line">    static synchronized ClassLoader a(Context context, String str, String str2) throws Exception &#123;</span><br><span class="line">        ClassLoader classLoader;</span><br><span class="line">        synchronized (PluginStatic.class) &#123;</span><br><span class="line">            classLoader = (DexClassLoader) c.get(str);</span><br><span class="line">            if (classLoader == null) &#123;</span><br><span class="line">                ClassLoader soDexClassLoader;</span><br><span class="line">                QLog.d(&quot;plugin_tag&quot;, 1, &quot;getOrCreateClassLoader:&quot; + str);</span><br><span class="line">                long currentTimeMillis = System.currentTimeMillis();</span><br><span class="line">                String canonicalPath = PluginUtils.getOptimizedDexPath(context).getCanonicalPath();</span><br><span class="line">                String canonicalPath2 = PluginUtils.getPluginLibPath(context, str).getCanonicalPath();</span><br><span class="line">                if (str2.endsWith(&quot;.so&quot;)) &#123;</span><br><span class="line">                    soDexClassLoader = new SoDexClassLoader(str2, canonicalPath, canonicalPath2, context.getClassLoader());</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    if (str.startsWith(&quot;qzone_live_video_plugin&quot;)) &#123;</span><br><span class="line">                        long currentTimeMillis2 = System.currentTimeMillis();</span><br><span class="line">                        ClassLoader orCreateClassLoader = getOrCreateClassLoader(context, &quot;qzone_plugin.apk&quot;);</span><br><span class="line">                        QLog.d(&quot;plugin_tag&quot;, 1, &quot;get qzone classloader cost=&quot; + (System.currentTimeMillis() - currentTimeMillis2));</span><br><span class="line">                        soDexClassLoader = new QZoneLiveClassLoader(str2, canonicalPath, canonicalPath2, orCreateClassLoader);</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        String str3;</span><br><span class="line">                        if (str2 != null) &#123;</span><br><span class="line">                            if (!new File(str2).exists()) &#123;</span><br><span class="line">                                QLog.d(&quot;plugin_tag&quot;, 1, &quot;getOrCreateClassLoader notExist  &quot; + str2);</span><br><span class="line">                                classLoader = new DexClassLoader(&quot;&quot;, canonicalPath, canonicalPath2, context.getClassLoader());</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (PluginUtils.isOsNeedReleaseDex() &amp;&amp; IPluginAdapterProxy.getProxy().isSupportMultiDex(str)) &#123;</span><br><span class="line">                            File multiDexSecondDex = PluginUtils.getMultiDexSecondDex(context, str);</span><br><span class="line">                            if (multiDexSecondDex.exists()) &#123;</span><br><span class="line">                                str3 = str2 + File.pathSeparator + multiDexSecondDex.getAbsolutePath();</span><br><span class="line">                                QLog.d(&quot;plugin_tag&quot;, 1, &quot;multiDex dexsPath&quot; + str3);</span><br><span class="line">                                QLog.d(&quot;plugin_tag&quot;, 1, &quot;dexsPath&quot; + str3);</span><br><span class="line">                                soDexClassLoader = new DexClassLoader(str3, canonicalPath, canonicalPath2, context.getClassLoader());</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        str3 = str2;</span><br><span class="line">                        QLog.d(&quot;plugin_tag&quot;, 1, &quot;dexsPath&quot; + str3);</span><br><span class="line">                        soDexClassLoader = new DexClassLoader(str3, canonicalPath, canonicalPath2, context.getClassLoader());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                PackageInfo packageInfo = (PackageInfo) d.get(str2);</span><br><span class="line">                if (packageInfo == null) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        packageInfo = ApkFileParser.getPackageInfoWithException(context, str2, 129);</span><br><span class="line">                    &#125; catch (Throwable th) &#123;</span><br><span class="line">                        DebugHelper.log(&quot;plugin_tag&quot;, &quot;PluginStatic.getOrCreateClassLoaderByPath Get Package Info Failed!&quot;, th);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (packageInfo == null) &#123;</span><br><span class="line">                        DebugHelper.log(&quot;PluginStatic.getOrCreateClassLoaderByPath Get Package Info Failed! &quot; + new File(str2).exists());</span><br><span class="line">                    &#125;</span><br><span class="line">                    d.put(str2, packageInfo);</span><br><span class="line">                &#125;</span><br><span class="line">                if (packageInfo != null) &#123;</span><br><span class="line">                    a(packageInfo, str, soDexClassLoader);</span><br><span class="line">                &#125;</span><br><span class="line">                QLog.w(&quot;plugin_tag&quot;, 1, &quot;getOrCreateClassLoaderCost:&quot; + str + &quot; c:&quot; + (System.currentTimeMillis() - currentTimeMillis));</span><br><span class="line">                c.put(str, soDexClassLoader);</span><br><span class="line">                classLoader = soDexClassLoader;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return classLoader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static List a() &#123;</span><br><span class="line">        return f;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static void a(PackageInfo packageInfo, String str, ClassLoader classLoader) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            if (((IPluginLife) e.get(str)) == null &amp;&amp; packageInfo != null &amp;&amp; packageInfo.applicationInfo != null &amp;&amp; packageInfo.applicationInfo.metaData != null) &#123;</span><br><span class="line">                String string = packageInfo.applicationInfo.metaData.getString(&quot;PLUGIN_LIFE_CLASS&quot;);</span><br><span class="line">                if (string != null) &#123;</span><br><span class="line">                    IPluginLife iPluginLife = (IPluginLife) classLoader.loadClass(string).newInstance();</span><br><span class="line">                    e.put(str, iPluginLife);</span><br><span class="line">                    iPluginLife.onLoad();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Throwable th) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static void a(IPluginActivity iPluginActivity) &#123;</span><br><span class="line">        b();</span><br><span class="line">        synchronized (f) &#123;</span><br><span class="line">            f.add(new WeakReference(iPluginActivity));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static boolean a(Bundle bundle) &#123;</span><br><span class="line">        if (bundle == null) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            String string = bundle.getString(PARAM_PLUGIN_LOCATION);</span><br><span class="line">            if (TextUtils.isEmpty(string) || string.substring(0, string.lastIndexOf(&quot;.&quot;)).contains(&quot;.&quot;) || TextUtils.isEmpty(bundle.getString(PARAM_PLUGIN_NAME))) &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">            string = bundle.getString(PARAM_PATH);</span><br><span class="line">            return !TextUtils.isEmpty(string) ? TextUtils.isEmpty(string) ? true : a(string) : false;</span><br><span class="line">        &#125; catch (Throwable th) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static boolean a(String str) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            if (str.contains(&quot;..&quot;)) &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">            if (!str.endsWith(&quot;.so&quot;)) &#123;</span><br><span class="line">                return str.endsWith(&quot;.apk&quot;) ? a(str, PluginUtils.getPluginInstallDir(BaseApplication.getContext())) : false;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                String parent = BaseApplication.getContext().getFilesDir().getParent();</span><br><span class="line">                File file = new File(parent + SoLoadCore.PATH_TX_LIB);</span><br><span class="line">                if (a(str, new File(parent + SoLoadCore.PATH_LIB)) || a(str, file)) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static boolean a(String str, File file) throws IOException &#123;</span><br><span class="line">        String canonicalPath = file.getCanonicalPath();</span><br><span class="line">        String canonicalPath2 = new File(str).getParentFile().getCanonicalPath();</span><br><span class="line">        if (QLog.isColorLevel()) &#123;</span><br><span class="line">            QLog.d(&quot;plugin_tag&quot;, 2, &quot;path:&quot; + str + &quot;-&gt; [&quot; + canonicalPath2 + &quot;, &quot; + canonicalPath + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return canonicalPath2.equals(canonicalPath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static void b() &#123;</span><br><span class="line">        synchronized (f) &#123;</span><br><span class="line">            int i = 0;</span><br><span class="line">            while (i &lt; f.size()) &#123;</span><br><span class="line">                int i2;</span><br><span class="line">                if (((WeakReference) f.get(i)).get() == null) &#123;</span><br><span class="line">                    f.remove(i);</span><br><span class="line">                    i2 = i - 1;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    i2 = i;</span><br><span class="line">                &#125;</span><br><span class="line">                i = i2 + 1;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static void b(IPluginActivity iPluginActivity) &#123;</span><br><span class="line">        b();</span><br><span class="line">        c(iPluginActivity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static String byteArrayToHex(byte[] byteArray) &#123;</span><br><span class="line">        int i = 0;</span><br><span class="line">        char[] cArr = new char[]&#123;&#x27;0&#x27;, &#x27;1&#x27;, &#x27;2&#x27;, &#x27;3&#x27;, &#x27;4&#x27;, &#x27;5&#x27;, &#x27;6&#x27;, &#x27;7&#x27;, &#x27;8&#x27;, &#x27;9&#x27;, &#x27;A&#x27;, &#x27;B&#x27;, &#x27;C&#x27;, &#x27;D&#x27;, &#x27;E&#x27;, &#x27;F&#x27;&#125;;</span><br><span class="line">        char[] cArr2 = new char[(byteArray.length * 2)];</span><br><span class="line">        int length = byteArray.length;</span><br><span class="line">        int i2 = 0;</span><br><span class="line">        while (i &lt; length) &#123;</span><br><span class="line">            byte b = byteArray[i];</span><br><span class="line">            int i3 = i2 + 1;</span><br><span class="line">            cArr2[i2] = cArr[(b &gt;&gt;&gt; 4) &amp; 15];</span><br><span class="line">            i2 = i3 + 1;</span><br><span class="line">            cArr2[i3] = cArr[b &amp; 15];</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        return new String(cArr2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static boolean c(IPluginActivity iPluginActivity) &#123;</span><br><span class="line">        synchronized (f) &#123;</span><br><span class="line">            for (int i = 0; i &lt; f.size(); i++) &#123;</span><br><span class="line">                if (((WeakReference) f.get(i)).get() == iPluginActivity) &#123;</span><br><span class="line">                    f.remove(i);</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static String encodeFile(String filePath) &#123;</span><br><span class="line">        Throwable e;</span><br><span class="line">        String str = &quot;&quot;;</span><br><span class="line">        File file = new File(filePath);</span><br><span class="line">        if (file.exists() &amp;&amp; file.isFile()) &#123;</span><br><span class="line">            FileInputStream fileInputStream;</span><br><span class="line">            try &#123;</span><br><span class="line">                byte[] bArr;</span><br><span class="line">                MessageDigest instance = MessageDigest.getInstance(&quot;MD5&quot;);</span><br><span class="line">                fileInputStream = new FileInputStream(file);</span><br><span class="line">                try &#123;</span><br><span class="line">                    bArr = new byte[16384];</span><br><span class="line">                &#125; catch (OutOfMemoryError e2) &#123;</span><br><span class="line">                    bArr = new byte[4096];</span><br><span class="line">                &#125;</span><br><span class="line">                while (true) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        int read = fileInputStream.read(bArr);</span><br><span class="line">                        if (read == -1) &#123;</span><br><span class="line">                            break;</span><br><span class="line">                        &#125;</span><br><span class="line">                        instance.update(bArr, 0, read);</span><br><span class="line">                    &#125; catch (Exception e3) &#123;</span><br><span class="line">                        e = e3;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                String byteArrayToHex = byteArrayToHex(instance.digest());</span><br><span class="line">                if (fileInputStream == null) &#123;</span><br><span class="line">                    return byteArrayToHex;</span><br><span class="line">                &#125;</span><br><span class="line">                try &#123;</span><br><span class="line">                    fileInputStream.close();</span><br><span class="line">                    return byteArrayToHex;</span><br><span class="line">                &#125; catch (IOException e4) &#123;</span><br><span class="line">                    return byteArrayToHex;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (Exception e5) &#123;</span><br><span class="line">                e = e5;</span><br><span class="line">                fileInputStream = null;</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (QLog.isColorLevel()) &#123;</span><br><span class="line">                        QLog.e(&quot;plugin_tag&quot;, 2, &quot;encode-Exception:&quot; + QLog.getStackTraceString(e));</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (fileInputStream != null) &#123;</span><br><span class="line">                        try &#123;</span><br><span class="line">                            fileInputStream.close();</span><br><span class="line">                        &#125; catch (IOException e6) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    return str;</span><br><span class="line">                &#125; catch (Throwable th) &#123;</span><br><span class="line">                    e = th;</span><br><span class="line">                    if (fileInputStream != null) &#123;</span><br><span class="line">                        try &#123;</span><br><span class="line">                            fileInputStream.close();</span><br><span class="line">                        &#125; catch (IOException e7) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    throw e;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (Throwable th2) &#123;</span><br><span class="line">                e = th2;</span><br><span class="line">                fileInputStream = null;</span><br><span class="line">                if (fileInputStream != null) &#123;</span><br><span class="line">                    fileInputStream.close();</span><br><span class="line">                &#125;</span><br><span class="line">                throw e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (QLog.isColorLevel()) &#123;</span><br><span class="line">            QLog.e(&quot;plugin_tag&quot;, 2, &quot;encode-File does not exist or is not file&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static synchronized ClassLoader getClassLoader(String pluginID) &#123;</span><br><span class="line">        DexClassLoader dexClassLoader;</span><br><span class="line">        synchronized (PluginStatic.class) &#123;</span><br><span class="line">            dexClassLoader = (DexClassLoader) c.get(pluginID);</span><br><span class="line">        &#125;</span><br><span class="line">        return dexClassLoader;</span><br><span class="line">    &#125;</span><br><span class="line">//加载红包插件也是这样玩的，实际上就是加载一个apk的dexclassloader,如果已缓存就从内从中取出，否则就加载一个， 传递plugindId,和 安装路径就饿可到了一个新的classloader</span><br><span class="line">    public static synchronized ClassLoader getOrCreateClassLoader(Context c, String pluginID) throws Exception &#123;</span><br><span class="line">        ClassLoader classLoader;</span><br><span class="line">        synchronized (PluginStatic.class) &#123;</span><br><span class="line">            classLoader = (ClassLoader) c.get(pluginID);</span><br><span class="line">            if (classLoader == null) &#123;</span><br><span class="line">                classLoader = a(c, pluginID, PluginUtils.getInstalledPluginPath(c, pluginID).getCanonicalPath());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return classLoader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static List isProcessesExist(Context c, List processNames) &#123;</span><br><span class="line">        if (processNames == null) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        List arrayList = new ArrayList();</span><br><span class="line">        List&lt;RunningAppProcessInfo&gt; runningAppProcesses = ((ActivityManager) c.getSystemService(&quot;activity&quot;)).getRunningAppProcesses();</span><br><span class="line">        if (runningAppProcesses == null) &#123;</span><br><span class="line">            for (int i = 0; i &lt; processNames.size(); i++) &#123;</span><br><span class="line">                arrayList.add(Boolean.FALSE);</span><br><span class="line">            &#125;</span><br><span class="line">            return arrayList;</span><br><span class="line">        &#125;</span><br><span class="line">        for (String str : processNames) &#123;</span><br><span class="line">            boolean z;</span><br><span class="line">            for (RunningAppProcessInfo runningAppProcessInfo : runningAppProcesses) &#123;</span><br><span class="line">                if (str.equalsIgnoreCase(runningAppProcessInfo.processName)) &#123;</span><br><span class="line">                    z = true;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            z = false;</span><br><span class="line">            arrayList.add(Boolean.valueOf(z));</span><br><span class="line">        &#125;</span><br><span class="line">        return arrayList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static synchronized ClassLoader removeClassLoader(String pluginId) &#123;</span><br><span class="line">        ClassLoader classLoader;</span><br><span class="line">        synchronized (PluginStatic.class) &#123;</span><br><span class="line">            QLog.d(&quot;plugin_tag&quot;, 1, &quot;removeClassLoader:&quot; + pluginId);</span><br><span class="line">            classLoader = (ClassLoader) c.remove(pluginId);</span><br><span class="line">        &#125;</span><br><span class="line">        return classLoader;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="分析QQ如何加载插件apk的so文件"><a href="#分析QQ如何加载插件apk的so文件" class="headerlink" title="分析QQ如何加载插件apk的so文件"></a>分析QQ如何加载插件apk的so文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class PluginUtils &#123;</span><br><span class="line">    public static final String CONFIG_FILE_EXTEND_NAME = &quot;.cfg&quot;;</span><br><span class="line">    private static final int a = 8192;</span><br><span class="line">    private static Map b = new ConcurrentHashMap();</span><br><span class="line">    private static Map c = new ConcurrentHashMap();</span><br><span class="line">    private static final String d = &quot;.tmp&quot;;</span><br><span class="line"></span><br><span class="line">    static class a extends Exception &#123;</span><br><span class="line">        private static final long a = 1;</span><br><span class="line"></span><br><span class="line">        public a(String str) &#123;</span><br><span class="line">            super(str);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class b extends Exception &#123;</span><br><span class="line">        private static final long a = 1;</span><br><span class="line"></span><br><span class="line">        b() &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static String getExceptionInfo(Throwable t) &#123;</span><br><span class="line">        while (t.getCause() != null) &#123;</span><br><span class="line">            t = t.getCause();</span><br><span class="line">        &#125;</span><br><span class="line">        Writer stringWriter = new StringWriter();</span><br><span class="line">        t.printStackTrace(new PrintWriter(stringWriter, true));</span><br><span class="line">        return stringWriter.getBuffer().toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面的源码可以看出来<code>extractLibs</code>方法做了这个事情，首先把apk文件读入到QZipFile,然后 得到实体遍历文件夹得到真正的apk路径。</p>
<p>上面的代码目前还无法得知干嘛的，暂时放一放谈谈pluginId,qq定义为一个没有路径的apk文件名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public String getPluginID() &#123;</span><br><span class="line">       return &quot;qwallet_plugin.apk&quot;;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">腾讯QQ的插件activity接口</span><br></pre></td></tr></table></figure>
<p>public interface IPluginActivity {<br>    boolean IDispatchTouchEvent(MotionEvent motionEvent);</p>
<pre><code>void IFinish();

View IGetContentView();

Handler IGetInHandler();

Resources IGetResource();

void IInit(String str, String str2, Activity activity, ClassLoader classLoader, PackageInfo packageInfo, boolean z, int i);

boolean IIsWrapContent();

void IOnActivityResult(int i, int i2, Intent intent);

void IOnAttachFragment(Fragment fragment);

boolean IOnBackPressed();

void IOnConfigurationChanged(Configuration configuration);

void IOnCreate(Bundle bundle);

boolean IOnCreateOptionsMenu(Menu menu);

void IOnDestroy();

boolean IOnKeyDown(int i, KeyEvent keyEvent);

boolean IOnKeyMultiple(int i, int i2, KeyEvent keyEvent);

boolean IOnKeyUp(int i, KeyEvent keyEvent);

boolean IOnMenuItemSelected(int i, MenuItem menuItem);

void IOnNewIntent(Intent intent);

boolean IOnOptionsItemSelected(MenuItem menuItem);

void IOnPause();

boolean IOnPrepareOptionsMenu(Menu menu);

void IOnRestart();

void IOnRestoreInstanceState(Bundle bundle);

void IOnResume();

void IOnSaveInstanceState(Bundle bundle);

void IOnSetTheme();

void IOnStart();

void IOnStop();

boolean IOnTouchEvent(MotionEvent motionEvent);

void IOnUserInteraction();

void IOnWindowFocusChanged(boolean z);

void ISetIntent(Intent intent);

void ISetIsTab();

void ISetOutHandler(Handler handler);

void ISetParent(BasePluginActivity basePluginActivity);

ImmersiveConfig IgetImmersiveConfig();
</code></pre>
<p>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">实现类```BasePluginActivity```</span><br><span class="line"></span><br><span class="line">![image.png](https://upload-images.jianshu.io/upload_images/2815884-f6d4592c4b971cca.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><br><span class="line">this.f就是插件apk,说明如果是插件模式的话就调用的是this.f ，也就是说这个插件apk是可以单独运行的。</span><br><span class="line"></span><br><span class="line">还是不看了，感觉由于不能跟踪代码，看起来头晕</span><br><span class="line">项目庞大，一般的分析工具都卡死了。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">再谈谈android 的其他hook 如破解签名hook</span><br></pre></td></tr></table></figure>


<p>interface IPackageManager {<br>    PackageInfo getPackageInfo(String packageName, int flags);<br>    int getPackageUid(String packageName);<br>    int[] getPackageGids(String packageName);</p>
<pre><code>String[] currentToCanonicalPackageNames(in String[] names);
String[] canonicalToCurrentPackageNames(in String[] names);

PermissionInfo getPermissionInfo(String name, int flags);

List&lt;PermissionInfo&gt; queryPermissionsByGroup(String group, int flags);

PermissionGroupInfo getPermissionGroupInfo(String name, int flags);

List&lt;PermissionGroupInfo&gt; getAllPermissionGroups(int flags);

ApplicationInfo getApplicationInfo(String packageName, int flags);

ActivityInfo getActivityInfo(in ComponentName className, int flags);

ActivityInfo getReceiverInfo(in ComponentName className, int flags);

ServiceInfo getServiceInfo(in ComponentName className, int flags);

ProviderInfo getProviderInfo(in ComponentName className, int flags);

int checkPermission(String permName, String pkgName);

int checkUidPermission(String permName, int uid);

boolean addPermission(in PermissionInfo info);

void removePermission(String name);

boolean isProtectedBroadcast(String actionName);

int checkSignatures(String pkg1, String pkg2);

int checkUidSignatures(int uid1, int uid2);

String[] getPackagesForUid(int uid);

String getNameForUid(int uid);

int getUidForSharedUser(String sharedUserName);

ResolveInfo resolveIntent(in Intent intent, String resolvedType, int flags);

List&lt;ResolveInfo&gt; queryIntentActivities(in Intent intent, 
        String resolvedType, int flags);

List&lt;ResolveInfo&gt; queryIntentActivityOptions(
        in ComponentName caller, in Intent[] specifics,
        in String[] specificTypes, in Intent intent,
        String resolvedType, int flags);

List&lt;ResolveInfo&gt; queryIntentReceivers(in Intent intent,
        String resolvedType, int flags);

ResolveInfo resolveService(in Intent intent,
        String resolvedType, int flags);

List&lt;ResolveInfo&gt; queryIntentServices(in Intent intent,
        String resolvedType, int flags);

ParceledListSlice getInstalledPackages(int flags, in String lastRead);


ParceledListSlice getInstalledApplications(int flags, in String lastRead);


List&lt;ApplicationInfo&gt; getPersistentApplications(int flags);

ProviderInfo resolveContentProvider(String name, int flags);


void querySyncProviders(inout List&lt;String&gt; outNames,
        inout List&lt;ProviderInfo&gt; outInfo);

List&lt;ProviderInfo&gt; queryContentProviders(
        String processName, int uid, int flags);

InstrumentationInfo getInstrumentationInfo(
        in ComponentName className, int flags);

List&lt;InstrumentationInfo&gt; queryInstrumentation(
        String targetPackage, int flags);

void installPackage(in Uri packageURI, IPackageInstallObserver observer, int flags,
        in String installerPackageName);

void finishPackageInstall(int token);
</code></pre>
<p> n performDexOpt(String packageName);</p>
<pre><code>void updateExternalMediaStatus(boolean mounted, boolean reportStatus);

String nextPackageToClean(String lastPackage);

void movePackage(String packageName, IPackageMoveObserver observer, int flags);

boolean addPermissionAsync(in PermissionInfo info);

boolean setInstallLocation(int loc);
int getInstallLocation();
</code></pre>
<p>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">hook</span><br></pre></td></tr></table></figure>
<p>public class IPackageManagerHook extends ProxyHook {</p>
<pre><code>private static final String TAG = IPackageManagerHook.class.getSimpleName();

public IPackageManagerHook(Context hostContext) &#123;
    super(hostContext);
&#125;

@Override
protected BaseHookHandle createHookHandle() &#123;
    return new IPackageManagerHookHandle(mHostContext);
&#125;

@Override
protected void onInstall(ClassLoader classLoader) throws Throwable &#123;
    Object currentActivityThread = ActivityThreadCompat.currentActivityThread();

    setOldObj(FieldUtils.readField(currentActivityThread, &quot;sPackageManager&quot;));
    Class&lt;?&gt; iPmClass = mOldObj.getClass();
    List&lt;Class&lt;?&gt;&gt; interfaces = Utils.getAllInterfaces(iPmClass);
    Class[] ifs = interfaces != null &amp;&amp; interfaces.size() &gt; 0 ? interfaces.toArray(new Class[interfaces.size()]) : new Class[0];
    Object newPm = MyProxy.newProxyInstance(iPmClass.getClassLoader(), ifs, this);
    FieldUtils.writeField(currentActivityThread, &quot;sPackageManager&quot;, newPm);
    PackageManager pm = mHostContext.getPackageManager();
    Object mPM = FieldUtils.readField(pm, &quot;mPM&quot;);
    if (mPM != newPm) &#123;
        FieldUtils.writeField(pm, &quot;mPM&quot;, newPm);
    &#125;
&#125;


public static void fixContextPackageManager(Context context) &#123;
    try &#123;
        Object currentActivityThread = ActivityThreadCompat.currentActivityThread();
        Object newPm = FieldUtils.readField(currentActivityThread, &quot;sPackageManager&quot;);
        PackageManager pm = context.getPackageManager();
        Object mPM = FieldUtils.readField(pm, &quot;mPM&quot;);
        if (mPM != newPm) &#123;
            FieldUtils.writeField(pm, &quot;mPM&quot;, newPm);
        &#125;
    &#125; catch (Exception e) &#123;
        e.printStackTrace();
    &#125;
&#125;
</code></pre>
<p>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hook启动的另外一一种方式</span><br></pre></td></tr></table></figure>
<p>public class InstrumentationHook extends Hook {</p>
<pre><code>private static final String TAG = InstrumentationHook.class.getSimpleName();
private List&lt;PluginInstrumentation&gt; mPluginInstrumentations = new ArrayList&lt;PluginInstrumentation&gt;();

public InstrumentationHook(Context hostContext) &#123;
    super(hostContext);
&#125;

@Override
protected BaseHookHandle createHookHandle() &#123;
    return null;
&#125;

@Override
public void setEnable(boolean enable, boolean reinstallHook) &#123;
    if (reinstallHook) &#123;
        try &#123;
            onInstall(null);
        &#125; catch (Throwable throwable) &#123;
            Log.i(TAG, &quot;setEnable onInstall fail&quot;, throwable);
        &#125;
    &#125;

    for (PluginInstrumentation pit : mPluginInstrumentations) &#123;
        pit.setEnable(enable);
    &#125;

    super.setEnable(enable,reinstallHook);
&#125;

@Override
protected void onInstall(ClassLoader classLoader) throws Throwable &#123;

    Object target = ActivityThreadCompat.currentActivityThread();
    Class ActivityThreadClass = ActivityThreadCompat.activityThreadClass();

     /*替换ActivityThread.mInstrumentation，拦截组件调度消息*/
    Field mInstrumentationField = FieldUtils.getField(ActivityThreadClass, &quot;mInstrumentation&quot;);
    Instrumentation mInstrumentation = (Instrumentation) FieldUtils.readField(mInstrumentationField, target);
    if (!PluginInstrumentation.class.isInstance(mInstrumentation)) &#123;
        PluginInstrumentation pit = new PluginInstrumentation(mHostContext, mInstrumentation);
        pit.setEnable(isEnable());
        mPluginInstrumentations.add(pit);
        FieldUtils.writeField(mInstrumentationField, target, pit);
        Log.i(TAG, &quot;Install Instrumentation Hook old=%s,new=%s&quot;, mInstrumentationField, pit);
    &#125; else &#123;
        Log.i(TAG, &quot;Instrumentation has installed,skip&quot;);
    &#125;
&#125;
</code></pre>
<p>}</p>
<pre><code>
</code></pre>
</div></article></div><div class="right-container"><div class="widget"><div class="category"><h4>分类归档</h4><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android-bug%E5%BC%82%E5%B8%B8%E4%B8%8E%E8%A7%A3%E5%86%B3/">Android-bug异常与解决</a><span class="category-list-count">46</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Blog/">Blog</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Photo/">Photo</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/QQ%E6%8A%80%E5%B7%A7/">QQ技巧</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/andorid%E8%A7%A6%E6%91%B8%E4%B8%8E%E6%BB%91%E5%8A%A8/">andorid触摸与滑动</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/android/">android</a><span class="category-list-count">149</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/android-System/">android-System</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/androidUi%E5%B7%A9%E5%9B%BA%E7%AC%94%E8%AE%B0/">androidUi巩固笔记</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/androidtv%E5%BC%80%E5%8F%91/">androidtv开发</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/android%E5%8A%A8%E7%94%BB/">android动画</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/android%E6%8F%92%E4%BB%B6%E5%8C%96/">android插件化</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/android%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">android源码分析</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/android%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%8E%E5%9B%BE%E5%BD%A2%E7%BB%98%E5%88%B6/">android自定义与图形绘制</a><span class="category-list-count">19</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/c/">c#</a><span class="category-list-count">61</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/c-c-JNI-Ndk/">c-c---JNI-Ndk</a><span class="category-list-count">76</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/eclipse/">eclipse</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/gradle/">gradle</a><span class="category-list-count">24</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ide%E6%8A%80%E5%B7%A7/">ide技巧</a><span class="category-list-count">20</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kotlin-with-java/">kotlin-with-java</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mac-ios/">mac-ios</a><span class="category-list-count">28</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">19</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/shell-bat-lua%E8%84%9A%E6%9C%AC/">shell-bat-lua脚本</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/window/">window</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%8A%E8%BD%A6/">上车</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%85%AC%E5%91%8A/">公告</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8A%9E%E5%85%AC/">办公</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%9C%B0%E7%90%83/">地球</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%9C%B0%E7%90%83/%E4%B8%AD%E5%9B%BD/">中国</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%9C%B0%E7%90%83/%E4%B8%AD%E5%9B%BD/%E6%B9%96%E5%8D%97/">湖南</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%9C%B0%E7%90%83/%E4%B8%AD%E5%9B%BD/%E6%B9%96%E5%8D%97/%E5%A8%84%E5%BA%95/">娄底</a><span class="category-list-count">1</span></li></ul></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%9E%83%E5%9C%BE%E5%A0%86/">垃圾堆</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A5%87%E6%B7%AB%E6%8A%80%E5%B7%A7/">奇淫技巧</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%8A%80%E5%B7%A7/">小程序技巧</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BB%BA%E6%A8%A1/">建模</a><span class="category-list-count">25</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%83%85%E8%BF%81QQ%E6%9C%BA%E5%99%A8%E4%BA%BA/">情迁QQ机器人</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%83%85%E8%BF%81%E8%BD%AF%E4%BB%B6/">情迁软件</a><span class="category-list-count">39</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%89%93%E8%B5%8F/">打赏</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E5%AD%A6/">数学</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%97%A5%E8%AE%B0%E6%9C%AC/">日记本</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B1%87%E7%BC%96/">汇编</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B5%8B%E8%AF%95/">测试</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B5%8B%E8%AF%95%E4%B8%8E%E8%87%AA%E5%8A%A8%E5%8C%96/">测试与自动化</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/">游戏开发</a><span class="category-list-count">68</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/">版本控制</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%94%9F%E6%B4%BB/">生活</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%A1%AC%E4%BB%B6%E7%BB%B4%E4%BF%AE/">硬件维修</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%A7%91%E5%B9%BB/">科幻</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%E6%95%B0%E5%AD%A6%E9%97%AE%E9%A2%98/">程序员的数学问题</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B%E6%9D%82%E9%A1%B9/">编程杂项</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%AB%99%E5%BB%BA%E8%AE%BE/">网站建设</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BE%8E%E5%A5%B3/">美女</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BF%BB%E8%AF%91%E8%A7%86%E9%A2%91%E6%95%99%E7%A8%8B/">翻译视频教程</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%B0%E5%BF%86/">记忆</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%B7%A8%E5%B9%B3%E5%8F%B0app/">跨平台app</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%B7%AF%E7%94%B1%E5%99%A8/">路由器</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%80%86%E5%90%91/">逆向</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%80%86%E5%90%91%E4%B8%8E%E5%AE%89%E5%85%A8/">逆向与安全</a><span class="category-list-count">87</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9A%8F%E7%AC%94/">随笔</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E8%AF%95%E6%94%BB%E5%85%8B/">面试攻克</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86/">音视频处理</a><span class="category-list-count">6</span></li></ul></div></div><div class="widget"><div class="tagcloud"><h4>标签云</h4><a href="/tags/Android-bug%E5%BC%82%E5%B8%B8%E4%B8%8E%E8%A7%A3%E5%86%B3/" style="font-size: 18.06px;">Android-bug异常与解决</a> <a href="/tags/CDN/" style="font-size: 10px;">CDN</a> <a href="/tags/Git/" style="font-size: 10.32px;">Git</a> <a href="/tags/JAVA/" style="font-size: 10px;">JAVA</a> <a href="/tags/Lua/" style="font-size: 10px;">Lua</a> <a href="/tags/QQ%E6%8A%80%E5%B7%A7/" style="font-size: 10px;">QQ技巧</a> <a href="/tags/WEB/" style="font-size: 10.32px;">WEB</a> <a href="/tags/andorid%E8%A7%A6%E6%91%B8%E4%B8%8E%E6%BB%91%E5%8A%A8/" style="font-size: 12.9px;">andorid触摸与滑动</a> <a href="/tags/android/" style="font-size: 19.68px;">android</a> <a href="/tags/android-studio/" style="font-size: 10px;">android studio</a> <a href="/tags/android-System/" style="font-size: 15.48px;">android-System</a> <a href="/tags/androidUi%E5%B7%A9%E5%9B%BA%E7%AC%94%E8%AE%B0/" style="font-size: 11.29px;">androidUi巩固笔记</a> <a href="/tags/androidtv%E5%BC%80%E5%8F%91/" style="font-size: 10.32px;">androidtv开发</a> <a href="/tags/android%E5%8A%A8%E7%94%BB/" style="font-size: 10.32px;">android动画</a> <a href="/tags/android%E6%8F%92%E4%BB%B6%E5%8C%96/" style="font-size: 14.19px;">android插件化</a> <a href="/tags/android%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" style="font-size: 11.94px;">android源码分析</a> <a href="/tags/android%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%8E%E5%9B%BE%E5%BD%A2%E7%BB%98%E5%88%B6/" style="font-size: 15.81px;">android自定义与图形绘制</a> <a href="/tags/c/" style="font-size: 18.39px;">c#</a> <a href="/tags/c-c-JNI-Ndk/" style="font-size: 19.03px;">c-c---JNI-Ndk</a> <a href="/tags/consectetur/" style="font-size: 10px;">consectetur</a> <a href="/tags/eclipse/" style="font-size: 11.29px;">eclipse</a> <a href="/tags/git/" style="font-size: 11.94px;">git</a> <a href="/tags/gradle/" style="font-size: 16.77px;">gradle</a> <a href="/tags/ide%E6%8A%80%E5%B7%A7/" style="font-size: 16.13px;">ide技巧</a> <a href="/tags/java/" style="font-size: 14.84px;">java</a> <a href="/tags/kotlin-with-java/" style="font-size: 15.16px;">kotlin-with-java</a> <a href="/tags/linux/" style="font-size: 11.61px;">linux</a> <a href="/tags/mac-ios/" style="font-size: 17.42px;">mac-ios</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/php/" style="font-size: 12.9px;">php</a> <a href="/tags/python/" style="font-size: 15.81px;">python</a> <a href="/tags/shell-bat-lua%E8%84%9A%E6%9C%AC/" style="font-size: 12.58px;">shell-bat-lua脚本</a> <a href="/tags/window/" style="font-size: 14.84px;">window</a> <a href="/tags/xposed%E6%8F%92%E4%BB%B6/" style="font-size: 10px;">xposed插件</a> <a href="/tags/%E4%B8%83%E7%89%9B/" style="font-size: 10px;">七牛</a> <a href="/tags/%E4%B8%8A%E8%BD%A6/" style="font-size: 11.61px;">上车</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99/" style="font-size: 10px;">代码编写</a> <a href="/tags/%E5%85%8DRoot/" style="font-size: 10px;">免Root</a> <a href="/tags/%E5%85%AC%E5%91%8A/" style="font-size: 10.32px;">公告</a> <a href="/tags/%E5%88%86%E8%BA%AB%E5%A4%A7%E5%B8%88/" style="font-size: 10px;">分身大师</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 12.9px;">前端</a> <a href="/tags/%E5%8A%9E%E5%85%AC/" style="font-size: 10px;">办公</a> <a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size: 10px;">后端</a> <a href="/tags/%E5%9B%BE%E7%89%87/" style="font-size: 10px;">图片</a> <a href="/tags/%E5%9E%83%E5%9C%BE%E5%A0%86/" style="font-size: 13.87px;">垃圾堆</a> <a href="/tags/%E5%A5%87%E6%B7%AB%E6%8A%80%E5%B7%A7/" style="font-size: 13.23px;">奇淫技巧</a> <a href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%8A%80%E5%B7%A7/" style="font-size: 14.19px;">小程序技巧</a> <a href="/tags/%E5%BB%BA%E6%A8%A1/" style="font-size: 17.1px;">建模</a> <a href="/tags/%E6%83%85%E8%BF%81QQ%E6%9C%BA%E5%99%A8%E4%BA%BA/" style="font-size: 10px;">情迁QQ机器人</a> <a href="/tags/%E6%83%85%E8%BF%81%E8%BD%AF%E4%BB%B6/" style="font-size: 17.74px;">情迁软件</a> <a href="/tags/%E6%89%93%E8%B5%8F/" style="font-size: 10px;">打赏</a> <a href="/tags/%E6%8F%92%E4%BB%B6/" style="font-size: 10px;">插件</a> <a href="/tags/%E6%95%B0%E5%AD%A6/" style="font-size: 11.61px;">数学</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 11.94px;">数据库</a> <a href="/tags/%E6%97%A5%E8%AE%B0%E6%9C%AC/" style="font-size: 10.65px;">日记本</a> <a href="/tags/%E6%9C%BA%E5%99%A8%E4%BA%BA/" style="font-size: 10px;">机器人</a> <a href="/tags/%E6%B1%87%E7%BC%96/" style="font-size: 10px;">汇编</a> <a href="/tags/%E6%B5%8B%E8%AF%95%E4%B8%8E%E8%87%AA%E5%8A%A8%E5%8C%96/" style="font-size: 10.32px;">测试与自动化</a> <a href="/tags/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/" style="font-size: 18.71px;">游戏开发</a> <a href="/tags/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/" style="font-size: 10.32px;">版本控制</a> <a href="/tags/%E7%94%9F%E6%B4%BB/" style="font-size: 14.52px;">生活</a> <a href="/tags/%E7%A1%AC%E4%BB%B6%E7%BB%B4%E4%BF%AE/" style="font-size: 10px;">硬件维修</a> <a href="/tags/%E7%A7%91%E5%B9%BB/" style="font-size: 10px;">科幻</a> <a href="/tags/%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%E6%95%B0%E5%AD%A6%E9%97%AE%E9%A2%98/" style="font-size: 13.55px;">程序员的数学问题</a> <a href="/tags/%E7%BC%96%E7%A8%8B%E6%9D%82%E9%A1%B9/" style="font-size: 16.45px;">编程杂项</a> <a href="/tags/%E7%BF%BB%E8%AF%91%E8%A7%86%E9%A2%91%E6%95%99%E7%A8%8B/" style="font-size: 10px;">翻译视频教程</a> <a href="/tags/%E8%97%8F%E5%93%81/" style="font-size: 20px;">藏品</a> <a href="/tags/%E8%A7%86%E9%A2%91/" style="font-size: 10px;">视频</a> <a href="/tags/%E8%AE%B0%E5%BF%86/" style="font-size: 10.97px;">记忆</a> <a href="/tags/%E8%B7%A8%E5%B9%B3%E5%8F%B0app/" style="font-size: 12.9px;">跨平台app</a> <a href="/tags/%E8%B7%AF%E7%94%B1%E5%99%A8/" style="font-size: 12.26px;">路由器</a> <a href="/tags/%E9%80%86%E5%90%91/" style="font-size: 10px;">逆向</a> <a href="/tags/%E9%80%86%E5%90%91%E4%B8%8E%E5%AE%89%E5%85%A8/" style="font-size: 19.35px;">逆向与安全</a> <a href="/tags/%E9%93%BE%E6%8E%A5/" style="font-size: 10.32px;">链接</a> <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 11.29px;">随笔</a> <a href="/tags/%E9%9D%A2%E8%AF%95%E6%94%BB%E5%85%8B/" style="font-size: 10px;">面试攻克</a> <a href="/tags/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86/" style="font-size: 11.61px;">音视频处理</a></div></div><div class="widget"><div class="recent"><h4>最近文章</h4><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2023/08/08/soft_use_status/">soft_use_status</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/08/08/hello-world%E4%B8%8Ehexo%E7%9A%84%E5%BC%80%E5%A7%8B/">Hello World</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/03/13/android-rxjava%E6%96%87%E6%9C%AC%E6%94%B9%E5%8F%98-%E5%88%87%E6%8D%A2%E5%90%8E%E5%8F%B0%E6%89%A7%E8%A1%8C-%E8%80%97%E6%97%B6%E5%A4%84%E7%90%86%E5%AE%8C%E6%AF%95%E5%86%8D%E8%BF%94%E5%9B%9E/">androidrxjava文本改变切换后台执行耗时处理完毕再返回</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/03/11/java%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AE%9A%E4%B9%89%E8%84%9A%E6%9C%AC%E8%A7%84%E5%88%99,%E8%A7%A3%E6%9E%90%E7%AE%80%E5%8D%95%E7%9A%84%E8%84%9A%E6%9C%AC%E5%AE%9E%E7%8E%B0%E6%89%93%E5%8D%B0%E5%9B%BE%E5%BD%A2%E5%B8%83%E5%B1%80%E5%AE%9A%E5%88%B6-%E5%92%A8%E8%AF%A2%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD%E6%89%BE%E5%AE%9E%E7%8E%B0%E7%81%B5%E6%84%9F1%E5%B0%8F%E6%97%B6%E5%AE%9E%E7%8E%B0/">java自定义定义脚本规则解析简单的脚本实现打印图形布局定制咨询人工智能找实现灵感1小时实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/03/11/%E6%95%B0%E5%AD%A6%E5%88%86%E9%85%8D%E7%9A%84%E7%AE%80%E5%8D%95%E5%A5%97%E8%B7%AF%E4%BB%A3%E7%A0%81/">数学分配的简单套路代码</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/03/03/%5B%E5%8E%9F%E5%88%9B%5Dandroid%E7%A6%81%E6%AD%A2%E7%BC%96%E8%BE%91%E6%A1%86%E7%BC%96%E8%BE%91%E4%BD%86%E6%98%AF%E5%85%81%E8%AE%B8%E9%80%89%E6%8B%A9%E6%9F%A5%E7%9C%8B%E5%86%85%E5%AE%B9%E8%B6%85%E5%87%BA%E7%9A%84%E9%83%A8%E5%88%86%E7%9A%84%E6%96%B9%E6%B3%95/">原创android禁止编辑框编辑但是允许选择查看内容超出的部分的方法</a></li></ul></div></div><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">搜索</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2018/04/02/android-studio%E4%BD%BF%E7%94%A8databind%E5%BC%95%E5%8F%91%E7%9A%84%E4%B8%80%E4%B8%AA%E7%9C%8B%E4%B8%8D%E5%88%B0%E4%BB%BB%E4%BD%95%E5%BE%81%E5%85%86%E7%9A%84%E9%94%99%E8%AF%AF/" class="prev">PREV</a><a href="/2018/04/01/-MediaFocusControl--Failure-to-signal-gain-of-audio-focus-due-to-/" class="next">NEXT</a></div><!--PC和WAP自适应版--><div id="SOHUCS" sid="2018/04/01/android插件化简要概述以及谈谈QQ的插件化原理大概/"> </div><script>(function() {
    var appid = 'cytVgXm93'; 
    var conf = 'e46b9c0a4ede5c70e062020c1d3651e1';
    var width = window.innerWidth || document.documentElement.clientWidth; 
    if (width < 960) { 
    window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })();</script><div class="copyright"><p>© 2015 - 2023 <a target="_blank">情随事迁</a>, 微博 <a href="https://weibo.com/qssq666" target="_blank">qssq666</a> <br>  <a href="https://space.bilibili.com/101043764?spm_id_from=333.1007.0.0" target="_blank">bilibli</a>  <a href="https://www.jianshu.com/u/9b0768e66d01" target="_blank">简书</a></p><p>总计访问量 <i data-hk-site="-"></i></p></div><div class="totop"><i></i></div></div></footer>
<script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="http://apps.bdimg.com/libs/jquery/1.8.2/jquery.min.js"></script><script src="/scripts/av-min-1.5.0.js"></script><script src="/scripts/hit-kounter-lc-0.3.0.js"></script><script src="/scripts/arAnchor.js"></script><script src="/scripts/main.js"></script></body></html>